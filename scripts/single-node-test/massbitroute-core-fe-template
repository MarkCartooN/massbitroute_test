
resource "google_compute_instance" "mbr-core-fe-new-commit-test" {
  name         = "${var.project_prefix}-${var.environment}-mbr-core-test-[[API_NODE_ID]]"
  machine_type = var.map_machine_types["mbr-core"]
  zone         = "${var.default_zone}"

  tags = ["http-server", "https-server"]

  boot_disk {
    initialize_params {
      image = "projects/ubuntu-os-cloud/global/images/ubuntu-2004-focal-v20210720"
      size = 2000
    }
  }

  network_interface {
    network = "${var.network_interface}"

    access_config {
      // Ephemeral IP
    }
  }

  metadata_startup_script =  <<EOH
  #!/bin/bash
  #-------------------------------------------
  #  Update host file for Massbitroute.dev
  #-------------------------------------------
  sudo echo '
127.0.0.1 hostmaster.massbitroute.dev
127.0.0.1 ns1.massbitroute.dev
127.0.0.1 ns2.massbitroute.dev
127.0.0.1 massbitroute.devdmin.massbitroute.dev
127.0.0.1 dapi.massbitroute.dev
127.0.0.1 massbitroute.devpi.massbitroute.dev
127.0.0.1 portal.massbitroute.dev
127.0.0.1 dev.massbitroute.dev
127.0.0.1 staging.massbitroute.dev
127.0.0.1 production.massbitroute.dev
127.0.0.1 status.dapi.massbitroute.dev
127.0.0.1 session.mbr.massbitroute.dev
127.0.0.1 monitor.mbr.massbitroute.dev
127.0.0.1 glmr1.bc.massbitroute.dev
127.0.0.1 dot1.bc.massbitroute.dev
127.0.0.1 chain.massbitroute.dev
127.0.0.1 staking.massbitroute.dev

[[MB]] verify.massbitroute.dev
127.0.0.1 fisherman.massbitroute.dev
127.0.0.1 stat.mbr.massbitroute.dev' >> /etc/hosts


  #-------------------------------------------
  #  Install frontend API
  #-------------------------------------------
  sudo apt install redis-server npm -y
  sudo systemctl enable redis-server
  npm install --global yarn
  npm cache clean -f
  npm install -g n
  n stable
  yarn global add pm2

  # Web Portal
  mkdir /opt/mbr-app
  git clone https://github.com/massbitprotocol/mbr-app -b dev /opt/mbr-app
  cd /opt/mbr-app
  yarn
  yarn build
  yarn start

  # Portal API
  mkdir /opt/user-management
  git clone https://github.com/massbitprotocol/user-management -b dev /opt/user-management
  cd /opt/user-management
  yarn
  yarn build
  pm2 start

  # staking APi
  mkdir /opt/test-massbit-staking
  git clone https://github.com/mison201/test-massbit-staking  /opt/test-massbit-staking
  cd /opt/test-massbit-staking
  yarn
  yarn build
  pm2 start


  EOH


  service_account {
    # Google recommends custom service.massbitroute.devccounts that have cloud-platform scope.massbitroute.devnd permissions granted via IAM Roles.
    email = "${var.email}"
    scopes = ["cloud-platform"]
  }

}

output "mbrcore_fe_public_ip" {
  description = "Public IP of new.massbitroute.devPI VM"
  value = google_compute_instance.mbr-core-fe-new-commit-test.network_interface.0.access_config.0.nat_ip
}

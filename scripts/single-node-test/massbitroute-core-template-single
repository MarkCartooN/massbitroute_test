

resource "google_compute_instance" "mbr-core-new-commit-test" {
  name         = "${var.project_prefix}-${var.environment}-mbr-core-test-[[API_NODE_ID]]"
  machine_type = var.map_machine_types["mbr-core"]
  zone         = "${var.default_zone}"

  tags = ["http-server", "https-server"]

  boot_disk {
    initialize_params {
      image = "projects/ubuntu-os-cloud/global/images/ubuntu-2004-focal-v20210720"
      size = 2000
    }
  }

  network_interface {
    network = "${var.network_interface}"

    access_config {
      // Ephemeral IP
    }
  }

  metadata_startup_script =  <<EOH
  #!/bin/bash
  #-------------------------------------------
  #  Update host file for Massbitroute.dev
  #-------------------------------------------
  sudo echo '
  127.0.0.1 hostmaster.massbitroute.dev
  127.0.0.1 ns1.massbitroute.dev
  127.0.0.1 ns2.massbitroute.dev
  127.0.0.1 massbitroute.devdmin.massbitroute.dev
  127.0.0.1 dapi.massbitroute.dev
  127.0.0.1 massbitroute.devpi.massbitroute.dev
  127.0.0.1 git.massbitroute.dev
  127.0.0.1 verify.massbitroute.dev
  127.0.0.1 fisherman.massbitroute.dev
  127.0.0.1 portal.massbitroute.dev
  127.0.0.1 dev.massbitroute.dev
  127.0.0.1 staging.massbitroute.dev
  127.0.0.1 production.massbitroute.dev
  127.0.0.1 status.dapi.massbitroute.dev
  127.0.0.1 stat.mbr.massbitroute.dev
  127.0.0.1 session.mbr.massbitroute.dev
  127.0.0.1 monitor.mbr.massbitroute.dev
  127.0.0.1 glmr1.bc.massbitroute.dev
  127.0.0.1 dot1.bc.massbitroute.dev
  127.0.0.1 chain.massbitroute.dev
  127.0.0.1 staking.massbitroute.dev' >> /etc/hosts

  #-------------------------------------------
  #  Install API
  #-------------------------------------------
  git clone https://github.com/massbitprotocol/massbitroute.git -b [[BRANCH_NAME]]  /massbit/massbitroute/app/src/sites/services/api
  dest_branch=[[MERGE_BRANCH]]
  echo "export MBR_ENV=$dest_branch">>/massbit/massbitroute/app/src/sites/services/api/.env
  sudo /massbit/massbitroute/app/src/sites/services/api/scripts/run _install
  sudo run _install >> /home/api_install.log

  #-------------------------------------------
  #  Install massbitroute core components
  #-------------------------------------------
  export GIT_PRIVATE_READ_URL="http://[[PRIVATE_GIT_READ_USERNAME]]:[[PRIVATE_GIT_READ_PASSWORD]]@[[PRIVATE_GIT_DOMAIN]]"
  curl https://raw.githubusercontent.com/massbitprotocol/massbitroute_dev/dev/scripts/install.sh | bash -x >> /home/core_install.log

  EOH


  service_account {
    # Google recommends custom service.massbitroute.devccounts that have cloud-platform scope.massbitroute.devnd permissions granted via IAM Roles.
    email = "${var.email}"
    scopes = ["cloud-platform"]
  }

}

output "api_public_ip" {
  description = "Public IP of new.massbitroute.devPI VM"
  value = google_compute_instance.mbr-core-new-commit-test.network_interface.0.access_config.0.nat_ip
}
